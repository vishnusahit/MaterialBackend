sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast","dataupload/lib/xlsx","dataupload/lib/xlsxf","dataupload/lib/jszip","sap/m/Dialog","sap/m/TextArea","sap/m/Label","sap/m/Button","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,a,o,n,l,s,i,r,u,d,c){"use strict";return e.extend("dataupload.controller.Main",{onInit:function(){var e=this.getView().getModel("odataV2");var t=localStorage.getItem("draftData");if(t){var a=JSON.parse(t);var e=new sap.ui.model.json.JSONModel(a);this.getView().setModel(e,"ExcelData")}},onBeforeOpen:function(e){var t=e.getSource();var a=this.getView().byId("idExceluploader");a.clear();this.getView().byId("confirmButton").setEnabled(false)},onAfterClose:function(e){var t=e.getSource();var a=this.getView().byId("idExceluploader");a.clear();t.destroy()},onFileAllowed:function(e){this.getView().byId("confirmButton").setEnabled(true)},onFileEmpty:function(e){this.getView().byId("confirmButton").setEnabled(false)},onTypeMismatch:function(e){var a=e.getSource().getFileType().map(function(e){return"*."+e}).join(", ");t.error("The file type *."+e.getParameter("fileType")+" is not supported. Choose one of the following types: "+a)},onUploadComplete:function(e){a.show("File upload complete")},onOk:function(e){var t=e.getSource().getParent();var o=this.getView().byId("idExceluploader");var n=o.oFileUpload.files[0];if(!n){a.show("Please select an Excel file.");return}var l=new FileReader;l.onload=e=>{var a=e.target.result;var o=XLSX.read(a,{type:"binary"});var n=o.SheetNames[0];var l=o.Sheets[n];var s=XLSX.utils.sheet_to_json(l);var i=new sap.ui.model.json.JSONModel(s);this.getView().setModel(i,"ExcelData");this.uploadData(s);t.close();t.destroy();this._exDialog=undefined};l.onerror=e=>{a.show("Error reading file: "+e)};l.readAsBinaryString(n)},uploadData:async function(e){var o=this.getView().getModel("odataV2");var n=[];e.forEach(function(e){n.push(new Promise(function(t,a){o.create("/mara_dummy",e,{success:function(e){t(e)},error:function(e){console.log(e);a(e)}})}))});Promise.all(n).then(function(e){a.show("All data uploaded successfully!");o.submitChanges({success:function(){a.show("Data saved successfully!");o.refresh(true)},error:function(e){t.error("Failed to save changes: "+e.message)}})}).catch(function(e){t.error("Upload failed: "+e.message)})},onDelete:function(){var e=this.getView().byId("rulesTable");var t=e.getSelectedItems();if(t.length>0){var o=this.getView().getModel("ExcelData");var n=o.getData();t.reverse().forEach(function(e){n.splice(e,1)});o.setData(n);o.refresh();a.show("Selected row(s) deleted successfully.");t.forEach(function(e){e.setSelected(false)})}else{a.show("Please select at least one row to delete.")}},onEdit:function(){var e=this.getView().byId("rulesTable");var t=e.getSelectedItems();if(t.length===1){var a=this.getView().getModel("ExcelData");var o=a.getData();var n=e.indexOfItem(t[0]);var l=o[n];var s=new sap.m.Dialog({title:"Edit Rule",content:[new sap.m.Label({text:"Table Name",labelFor:"tableName"}),new sap.m.Input("tableName",{value:l.Table_name,width:"100%"}),new sap.m.Label({text:"Column Name",labelFor:"columnName"}),new sap.m.Input("columnName",{value:l.Column_name,width:"100%"}),new sap.m.Label({text:"Column Description",labelFor:"columnDescription"}),new sap.m.Input("columnDescription",{value:l.Column_description,width:"100%"}),new sap.m.Label({text:"Business Rule Name",labelFor:"businessRuleName"}),new sap.m.Input("businessRuleName",{value:l.Business_rule_name,width:"100%"}),new sap.m.Label({text:"Rule Type",labelFor:"ruleType"}),new sap.m.Input("ruleType",{value:l.Rule_type,width:"100%"}),new sap.m.Label({text:"Rule Definition",labelFor:"ruleDefinition"}),new sap.m.TextArea("ruleDefinition",{value:l.Rule_Definition,width:"100%",rows:4})],beginButton:new sap.m.Button({text:"Save",press:function(){var t=sap.ui.getCore().byId("tableName").getValue();var l=sap.ui.getCore().byId("columnName").getValue();var i=sap.ui.getCore().byId("columnDescription").getValue();var r=sap.ui.getCore().byId("businessRuleName").getValue();var u=sap.ui.getCore().byId("ruleType").getValue();var d=sap.ui.getCore().byId("ruleDefinition").getValue();o[n].Table_name=t;o[n].Column_name=l;o[n].Column_description=i;o[n].Business_rule_name=r;o[n].Rule_type=u;o[n].Rule_Definition=d;a.setData(o);a.refresh();e.getItems()[n].setSelected(false);sap.m.MessageToast.show("Rule updated successfully.");s.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){s.close()}}),afterClose:function(){s.destroy()}});this.getView().addDependent(s);s.open()}else{sap.m.MessageToast.show("Please select exactly one row to edit.")}},onExcelUploadBtnPress:function(){if(!this._exDialog){this._exDialog=d.load({id:this.getView().getId(),name:"dataupload.view.fragments.uploadExcel",controller:this}).then(function(e){this.getView().addDependent(e);e.open()}.bind(this))}else{this._exDialog.then(function(e){e.open()})}},onCancel:function(e){var t=e.getSource().getParent();t.close();t.destroy();this._exDialog=undefined},onDownloadTemplate:function(){var e=[{Table_name:"",Column_name:"",Column_description:"",Business_rule_name:"",Rule_type:"",Rule_Definition:""}];var t=XLSX.utils.json_to_sheet(e);var o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,t,"Template");var n="template.xlsx";XLSX.writeFile(o,n);a.show("Template downloaded successfully!")},onBeforeOpenDuplicates:function(e){var t=e.getSource();var a=this.getView().getModel("duplicatesModel");if(a){a.refresh()}},onAfterCloseDuplicates:function(e){oExtensionAPI.removeDependent(oUploadDialog);oUploadDialog.destroy();oUploadDialog=undefined},onCancelDuplicates:function(e){var t=e.getSource().getParent();t.close();t.destroy()},closeDialog:function(){oUploadDialog&&oUploadDialog.close()},onCreate:function(){var e;var t=new c;var o="https://py_mdg_duplicate_chk.cfapps.us10-001.hana.ondemand.com/result";$.ajax({url:o,method:"GET",dataType:"json",contentType:"application/json",data:e,success:function(e){sap.ui.core.BusyIndicator.hide();console.log("Data received: ",e);t.setData(e);a.show("Data loaded successfully.")},error:function(e){sap.ui.core.BusyIndicator.hide();a.show("Failed to load data from the Python service.")}});this.loadFragment({id:"uploadDialog",name:"dataupload.view.fragments.duplicate",controller:this}).then(function(e){e.setModel(t,"duplicatesModel");e.open()})},onDraftPress:function(){var e=this.getView().getModel("ExcelData");var t=e.getData();localStorage.setItem("draftData",JSON.stringify(t));a.show("Data as Draft saved successfully!")}})});
//# sourceMappingURL=Main.controller.js.map